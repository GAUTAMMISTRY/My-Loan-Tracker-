<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Home Loan Tracker</title>

<!-- Bootstrap -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Excel Export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
body {
    background: #f4f6f9;
}
.card {
    border-radius: 15px;
}
.paid-row {
    background-color: #d4edda !important;
}
.remaining-row {
    background-color: #ffffff;
}
.table thead {
    background: #0d6efd;
    color: white;
}
.summary-box {
    font-size: 18px;
}
</style>
</head>

<body>

<div class="container mt-4">
    <h2 class="text-center mb-4">üè† Home Loan Tracker</h2>

    <!-- INPUT -->
    <div class="card shadow p-4">
        <div class="row g-3">
            <div class="col-md-3">
                <label>Loan Start Month</label>
                <input type="month" id="startMonth" class="form-control">
            </div>
            <div class="col-md-2">
                <label>Tenure (Years)</label>
                <input type="number" id="tenure" class="form-control" placeholder="20">
            </div>
            <div class="col-md-3">
                <label>Loan Amount (‚Çπ)</label>
                <input type="number" id="loanAmount" class="form-control" placeholder="2000000">
            </div>
            <div class="col-md-2">
                <label>Interest %</label>
                <input type="number" step="0.01" id="interest" class="form-control" placeholder="8.5">
            </div>
            <div class="col-md-2 d-grid">
                <label>&nbsp;</label>
                <button id="calculate" class="btn btn-primary btn-lg">OK</button>
            </div>
        </div>
    </div>

    <!-- RESULT -->
    <div id="result" class="mt-5" style="display:none;">

        <!-- SUMMARY -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card shadow p-3 summary-box">
                    <strong>Total Paid Till Now</strong><br>
                    ‚Çπ <span id="totalPaid"></span>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card shadow p-3 summary-box">
                    <strong>Remaining Loan</strong><br>
                    ‚Çπ <span id="remainingLoan"></span>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card shadow p-3 summary-box">
                    <strong>Monthly EMI</strong><br>
                    ‚Çπ <span id="emiAmount"></span>
                </div>
            </div>
        </div>

        <!-- ACTION BUTTONS -->
        <div class="row mb-3">
            <div class="col-md-6 d-grid">
                <button class="btn btn-success" onclick="exportExcel()">‚¨á Export to Excel</button>
            </div>
            <div class="col-md-6 d-grid">
                <button class="btn btn-dark" onclick="scrollToChart()">üìä View EMI Chart</button>
            </div>
        </div>

        <!-- TABLE -->
        <div class="card shadow">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>EMI Date</th>
                                <th>Principal (‚Çπ)</th>
                                <th>Interest (‚Çπ)</th>
                                <th>Total EMI (‚Çπ)</th>
                                <th>Balance (‚Çπ)</th>
                            </tr>
                        </thead>
                        <tbody id="emiTable"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- CHART -->
        <div class="card shadow mt-4" id="chartSection">
            <div class="card-body">
                <canvas id="emiChart"></canvas>
            </div>
        </div>

    </div>
</div>

<script>
let chart;

$("#calculate").click(function () {

    let startMonth = $("#startMonth").val();
    let tenureYears = parseInt($("#tenure").val());
    let loanAmount = parseFloat($("#loanAmount").val());
    let interest = parseFloat($("#interest").val());

    if (!startMonth || !tenureYears || !loanAmount || !interest) {
        alert("Please fill all fields");
        return;
    }

    let months = tenureYears * 12;
    let monthlyRate = interest / 12 / 100;

    let emi = loanAmount * monthlyRate * Math.pow(1 + monthlyRate, months) /
              (Math.pow(1 + monthlyRate, months) - 1);
    emi = Math.round(emi);

    let balance = loanAmount;
    let totalPaid = 0;
    let today = new Date();

    let labels = [], principalArr = [], interestArr = [], balanceArr = [];

    $("#emiTable").html("");

    let startDate = new Date(startMonth + "-01");

    for (let i = 1; i <= months; i++) {

        let interestPart = Math.round(balance * monthlyRate);
        let principalPart = emi - interestPart;
        balance -= principalPart;
        if (balance < 0) balance = 0;

        let emiDate = new Date(startDate);
        emiDate.setMonth(emiDate.getMonth() + i - 1);

        let paid = emiDate <= today;
        if (paid) totalPaid += emi;

        let rowClass = paid ? "paid-row" : "remaining-row";

        let label = emiDate.toLocaleDateString("en-IN", {month:"short", year:"numeric"});

        labels.push(label);
        principalArr.push(principalPart);
        interestArr.push(interestPart);
        balanceArr.push(Math.round(balance));

        $("#emiTable").append(`
            <tr class="${rowClass}">
                <td>${label}</td>
                <td>${principalPart.toLocaleString()}</td>
                <td>${interestPart.toLocaleString()}</td>
                <td>${emi.toLocaleString()}</td>
                <td>${Math.round(balance).toLocaleString()}</td>
            </tr>
        `);
    }

    $("#emiAmount").text(emi.toLocaleString());
    $("#totalPaid").text(totalPaid.toLocaleString());
    $("#remainingLoan").text(Math.round(balance).toLocaleString());

    $("#result").fadeIn();
    $('html, body').animate({ scrollTop: $("#result").offset().top }, 600);

    renderChart(labels, principalArr, interestArr, balanceArr);
});

function renderChart(labels, principal, interest, balance) {

    if (chart) chart.destroy();

    chart = new Chart(document.getElementById("emiChart"), {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                { label: 'Principal', data: principal, borderWidth: 2 },
                { label: 'Interest', data: interest, borderWidth: 2 },
                { label: 'Remaining Balance', data: balance, borderWidth: 2 }
            ]
        },
        options: {
            responsive: true,
            interaction: {
                mode: 'index',
                intersect: false
            }
        }
    });
}

function exportExcel() {
    let table = document.querySelector("table");
    let wb = XLSX.utils.table_to_book(table, { sheet: "EMI Schedule" });
    XLSX.writeFile(wb, "Home_Loan_EMI_Schedule.xlsx");
}

function scrollToChart() {
    $('html, body').animate({
        scrollTop: $("#chartSection").offset().top
    }, 600);
}
</script>

</body>
</html>
